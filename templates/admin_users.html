{% extends "base.html" %}

{% block title %}User Management - VisuDSA{% endblock %}

{% block content %}
<div class="container">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-users-cog"></i> User Management</h2>
        <div>
            <a href="{{ url_for('admin_dashboard') }}" class="btn btn-outline-secondary me-2">
                <i class="fas fa-arrow-left"></i> Back to Dashboard
            </a>
            <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
                <i class="fas fa-home"></i> Platform
            </a>
        </div>
    </div>
    
    <!-- Search and Filter -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <div class="input-group">
                        <input type="text" class="form-control" id="searchInput" placeholder="Search users...">
                        <button class="btn btn-outline-secondary" type="button" id="searchBtn">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div class="col-md-6">
                    <select class="form-select" id="statusFilter">
                        <option value="">All Users</option>
                        <option value="active">Active</option>
                        <option value="blocked">Blocked</option>
                        <option value="admin">Admins</option>
                    </select>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Users Table -->
    <div class="card">
        <div class="card-header">
            <h5><i class="fas fa-users"></i> All Users ({{ users.total }} total)</h5>
        </div>
        <div class="card-body">
            {% if users.items %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Joined</th>
                                <th>Last Login</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for user in users.items %}
                            <tr data-user-id="{{ user.id }}" data-status="{{ 'blocked' if user.is_blocked else 'active' }}" data-role="{{ 'admin' if user.is_admin else 'user' }}">
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-circle me-2">
                                            {{ user.username[0].upper() }}
                                        </div>
                                        <div>
                                            <strong>{{ user.username }}</strong>
                                            {% if user.is_admin %}
                                                <span class="badge bg-danger ms-1">Admin</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                </td>
                                <td class="text-muted">{{ user.email }}</td>
                                <td>
                                    {% if user.is_blocked %}
                                        <span class="badge bg-danger">Blocked</span>
                                        {% if user.blocked_reason %}
                                            <small class="text-muted d-block">{{ user.blocked_reason[:50] }}{% if user.blocked_reason|length > 50 %}...{% endif %}</small>
                                        {% endif %}
                                    {% else %}
                                        <span class="badge bg-success">Active</span>
                                    {% endif %}
                                </td>
                                <td class="text-muted small">{{ user.created_at.strftime('%Y-%m-%d') }}</td>
                                <td class="text-muted small">
                                    {% if user.last_login %}
                                        {{ user.last_login.strftime('%Y-%m-%d %H:%M') }}
                                    {% else %}
                                        Never
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm" role="group">
                                        {% if not user.is_admin %}
                                            {% if user.is_blocked %}
                                                <button class="btn btn-outline-success" onclick="unblockUser({{ user.id }})" title="Unblock User">
                                                    <i class="fas fa-unlock"></i>
                                                </button>
                                            {% else %}
                                                <button class="btn btn-outline-warning" onclick="blockUser({{ user.id }})" title="Block User">
                                                    <i class="fas fa-lock"></i>
                                                </button>
                                            {% endif %}
                                            <button class="btn btn-outline-danger" onclick="deleteUser({{ user.id }}, '{{ user.username }}')" title="Delete User">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        {% else %}
                                            <span class="text-muted small">Protected</span>
                                        {% endif %}
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination -->
                {% if users.pages > 1 %}
                <nav aria-label="User pagination">
                    <ul class="pagination justify-content-center">
                        {% if users.has_prev %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('admin_users', page=users.prev_num) }}">Previous</a>
                            </li>
                        {% endif %}
                        
                        {% for page_num in users.iter_pages() %}
                            {% if page_num %}
                                {% if page_num != users.page %}
                                    <li class="page-item">
                                        <a class="page-link" href="{{ url_for('admin_users', page=page_num) }}">{{ page_num }}</a>
                                    </li>
                                {% else %}
                                    <li class="page-item active">
                                        <span class="page-link">{{ page_num }}</span>
                                    </li>
                                {% endif %}
                            {% else %}
                                <li class="page-item disabled">
                                    <span class="page-link">â€¦</span>
                                </li>
                            {% endif %}
                        {% endfor %}
                        
                        {% if users.has_next %}
                            <li class="page-item">
                                <a class="page-link" href="{{ url_for('admin_users', page=users.next_num) }}">Next</a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            {% else %}
                <div class="text-center py-4">
                    <i class="fas fa-users fa-3x text-muted mb-3"></i>
                    <p class="text-muted">No users found.</p>
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Block User Modal -->
<div class="modal fade" id="blockModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Block User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to block this user?</p>
                <div class="mb-3">
                    <label for="blockReason" class="form-label">Reason (optional):</label>
                    <textarea class="form-control" id="blockReason" rows="3" placeholder="Enter reason for blocking..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" id="confirmBlock">Block User</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete User Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-danger">Delete User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete this user?</p>
                <p class="text-danger"><strong>This action cannot be undone and will permanently delete all user data.</strong></p>
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <strong>Warning:</strong> This will delete all progress, quiz attempts, and code submissions associated with this user.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDelete">Delete User</button>
            </div>
        </div>
    </div>
</div>

<style>
.avatar-circle {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background-color: #007bff;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    font-size: 14px;
}
</style>

<script>
let currentUserId = null;

// Search functionality
document.getElementById('searchInput').addEventListener('input', function() {
    const searchTerm = this.value.toLowerCase();
    const rows = document.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        const username = row.querySelector('strong').textContent.toLowerCase();
        const email = row.querySelector('.text-muted').textContent.toLowerCase();
        
        if (username.includes(searchTerm) || email.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

// Filter functionality
document.getElementById('statusFilter').addEventListener('change', function() {
    const filter = this.value;
    const rows = document.querySelectorAll('tbody tr');
    
    rows.forEach(row => {
        const status = row.getAttribute('data-status');
        const role = row.getAttribute('data-role');
        
        if (filter === '' || 
            (filter === 'active' && status === 'active') ||
            (filter === 'blocked' && status === 'blocked') ||
            (filter === 'admin' && role === 'admin')) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

function blockUser(userId) {
    currentUserId = userId;
    const modal = new bootstrap.Modal(document.getElementById('blockModal'));
    modal.show();
}

function unblockUser(userId) {
    if (confirm('Are you sure you want to unblock this user?')) {
        fetch(`/admin/unblock-user/${userId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert('Error: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while unblocking the user.');
        });
    }
}

function deleteUser(userId, username) {
    currentUserId = userId;
    document.querySelector('#deleteModal .modal-body p').innerHTML = 
        `Are you sure you want to delete user <strong>${username}</strong>?`;
    const modal = new bootstrap.Modal(document.getElementById('deleteModal'));
    modal.show();
}

document.getElementById('confirmBlock').addEventListener('click', function() {
    const reason = document.getElementById('blockReason').value;
    
    fetch(`/admin/block-user/${currentUserId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ reason: reason })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while blocking the user.');
    });
});

document.getElementById('confirmDelete').addEventListener('click', function() {
    fetch(`/admin/delete-user/${currentUserId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while deleting the user.');
    });
});
</script>
{% endblock %}
